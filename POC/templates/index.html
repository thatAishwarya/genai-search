<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Regulator Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div id="chat">
        <h1>Financial Regulator Chatbot</h1>
        <div id="suggestions">
            <div class="suggestion-card">What are the latest regulations?</div>
            <div class="suggestion-card">How can I file a complaint?</div>
            <div class="suggestion-card">What are the reporting requirements?</div>
        </div>
        <div id="chat-box">
            <!-- Chat history will be appended here -->
        </div>
        <div id="query-container">
            <input type="text" id="query" placeholder="Enter your question here" required>
            <button id="ask-button"><i class="fas fa-paper-plane"></i></button>
            <button id="clear-chat-button"><i class="fas fa-times"></i></button>
        </div>
        <div id="response" style="display: none;">
            <!-- Response will be displayed here -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add functionality to suggestion cards
            document.querySelectorAll('.suggestion-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.getElementById('query').value = this.textContent;
                    handleSubmit();
                });
            });

            // Add click event to the Ask button
            document.getElementById('ask-button').addEventListener('click', function() {
                handleSubmit();
            });

            // Add click event to the Clear Chat button
            document.getElementById('clear-chat-button').addEventListener('click', function() {
                clearChat();
            });

            function handleSubmit() {
                let query = document.getElementById('query').value;
                console.log('Query:', query); // Debugging: log the query

                // Display user query in chat box
                let chatBox = document.getElementById('chat-box');
                let userQueryBubble = document.createElement('div');
                userQueryBubble.className = 'chat-bubble user-query';
                userQueryBubble.textContent = query;
                chatBox.appendChild(userQueryBubble);

                fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ 'query': query })
                })
                .then(response => response.json())
                .then(data => {
                    let responseDiv = document.getElementById('response');
                    responseDiv.innerHTML = ''; // Clear any existing content
                    responseDiv.style.display = 'block'; // Make sure the response div is visible

                    if (data && data.length > 0) {
                        data.forEach(item => {
                            let botResponseBubble = document.createElement('div');
                            botResponseBubble.className = 'chat-bubble bot-response';

                            // Title of the response (question asked)
                            let title = document.createElement('div');
                            title.className = 'title';
                            title.textContent = query;
                            
                            // Abstractive answer
                            let responseContent = document.createElement('div');
                            responseContent.className = 'response-content';
                            responseContent.textContent = item.response;

                            // Reference cards
                            let references = document.createElement('div');
                            references.className = 'references';
                            let referenceCard = document.createElement('div');
                            referenceCard.className = 'reference-card';
                            referenceCard.innerHTML = `
                                <p>Document: ${item.document}</p>
                                <p>Page: ${item.page}</p>
                            `;
                            references.appendChild(referenceCard);

                            botResponseBubble.appendChild(title);
                            botResponseBubble.appendChild(responseContent);
                            botResponseBubble.appendChild(references);

                            chatBox.appendChild(botResponseBubble);
                        });

                        // Scroll to the bottom of the chat box
                        chatBox.scrollTop = chatBox.scrollHeight;
                    } else {
                        responseDiv.textContent = 'No response available.';
                    }
                })
                .catch(error => {
                    console.error('Error:', error); // Debugging: log any errors
                    let responseDiv = document.getElementById('response');
                    responseDiv.textContent = 'An error occurred while fetching the response.';
                    responseDiv.style.display = 'block';
                });
            }

            function clearChat() {
                document.getElementById('chat-box').innerHTML = ''; // Clear chat history
                let responseDiv = document.getElementById('response');
                responseDiv.innerHTML = ''; // Clear response area
                responseDiv.style.display = 'none'; // Hide response area
                document.getElementById('query').value = ''; // Clear input field
            }
        });
    </script>
</body>
</html>
